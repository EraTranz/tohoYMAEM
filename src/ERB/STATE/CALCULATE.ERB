;===============================================================================
;About Calculation
;===============================================================================
;生きている
@IF_ALIVE, ARG
#FUNCTION
IF !TALENT:ARG:死亡 && (BASE:ARG:体力 > 0 || BASE:ARG:底力 > 0)
	RETURNF 1
ELSE
	RETURNF 0
ENDIF

;底力
@FORCE_DOWN, ARG
SIF (TEQUIP:時間止め && TFLAG:158 != ARG) || TALENT:ARG:死亡 || BASE:ARG:体力 >= BASE:ARG:底力
	RETURN 0
LOCAL = MAXBASE:ARG:0 * 10000
LOCAL:1 = (MAXBASE:ARG:0 - BASE:ARG:体力) * 250
LOCAL:1 /= MAXBASE:ARG:0
LOCAL:2 = MAX(BASE:ARG:体力, 1) * 400
LOCAL:2 /= MAX(BASE:ARG:底力, 1)
LOCAL /= 150 + LOCAL:1 + LOCAL:2
LOCAL /= 100
BASE:ARG:底力 = LIMIT(BASE:ARG:底力 - LOCAL, BASE:ARG:体力, MAXBASE:ARG:0)

;識別パスワード(FLAG:9548)
@DATA_CHECK, ARG
#FUNCTION
RETURNF FLAG:9548

;識別パスワード(CFLAG:3700)
@MASTER_CHECK, ARG
#FUNCTION
IF CFLAG:ARG:3700 == DATA_CHECK(ARG)
	RETURNF 1
ELSE
	RETURNF 0
ENDIF

;識別パスワード(CFLAG:3701)
@TRAINER_CHECK, ARG
#FUNCTION
IF CFLAG:ARG:3701 == DATA_CHECK(ARG)
	RETURNF 1
ELSE
	RETURNF 0
ENDIF

;識別パスワード(CFLAG:3700)
@MASTER_CHANGE, ARG
CFLAG:ARG:3700 = DATA_CHECK(ARG)


;識別パスワード(CFLAG:3701)
@TRAINER_CHANGE, ARG
CFLAG:ARG:3701 = DATA_CHECK(ARG)

;識別パスワード(CFLAG:3700)
@MASTER_NAME_CHANGE, ARG, ARG:1
SIF NAME:MASTER == "あなた"
	RETURN 0

IF TALENT:ARG:旦那あり && ARG:1 >= 3
	CSTR:ARG:34 = NAME:MASTER
ELSEIF TALENT:ARG:彼氏あり && ARG:1 >= 2
	CSTR:ARG:34 = NAME:MASTER
ELSEIF TALENT:ARG:思い人あり && ARG:1 >= 1
	CSTR:ARG:34 = NAME:MASTER
ENDIF

@MARK_CALCULATE_2, ARG
#FUNCTION
LOCAL:1 = 0
;特定の素質を持たない助手プレイ中は刻印が付きづらい
SIF ASSI >= 0 && ASSIPLAY && TALENT:ASSI:魅惑 == 0 && TALENT:ASSI:謎の魅力 == 0 && TALENT:ASSI:小悪魔 == 0 && TALENT:ASSI:鼓舞 == 0
	LOCAL:1 = 1
LOCAL:2 = 0
LOCAL = UP:12 + UP:13/5 - UP:20 - UP:21
SIF LOCAL:1 == 1
	TIMES LOCAL , 0.60
SIF LOCAL >= 1500 * ARG
	LOCAL:2 = 1
LOCAL = UP:0 + UP:1 + UP:2 + UP:3 - UP:20 - UP:21
SIF LOCAL:1 == 1
	TIMES LOCAL , 0.80
SIF LOCAL >= 5000 * ARG
	LOCAL:2 = 2
LOCAL = UP:12 + UP:13/5 - UP:20 - UP:21
SIF LOCAL:1 == 1
	TIMES LOCAL , 0.60
SIF LOCAL >= 3000 * ARG
	LOCAL:2 = 3
RETURNF LOCAL:2

@ACCEPTANCE_UP, ARG, ARG:1, ARG:2 = 0
CFLAG:ARG:3668 = LIMIT(CFLAG:ARG:3668 + ARG:1, -1000, 1000)
SIF ARG:1 == 0 || !(FLAG:12 & 4) || (CFLAG:ARG:3668 >= 1000 && ARG:1 > 0) || (CFLAG:ARG:3668 <= -1000 && ARG:1 < 0)
	RETURN 0
PRINTFORM %CALLNAME:ARG%の調教度は
PRINTFORM {CFLAG:ARG:3668 / 10}.
IF CFLAG:ARG:3668 >= 0
	PRINTFORM {CFLAG:ARG:3668 % 10}
ELSE
	PRINTFORM {CFLAG:ARG:3668 % 10 * -1}
ENDIF
PRINT ％
SELECTCASE ARG:2
	;WAITを掛ける
	CASE 0
		PRINTFORMW です
	;WAITを掛けない
	CASEELSE
		PRINTFORML です
ENDSELECT

@EX_CALCULATION, ARG, ARG:1, ARG:2
SIF !(TFLAG:999 == 1 && ARG == TARGET)
	RETURN ARG:1
SELECTCASE ARG:2
	CASE IS <= 0
		TIMES ARG:1, 1.00
	CASE IS <= 2
		TIMES ARG:1, 1.05
	CASE IS <= 4
		TIMES ARG:1, 1.10
	CASE IS <= 6
		TIMES ARG:1, 1.15
	CASE IS <= 8
		TIMES ARG:1, 1.20
	CASEELSE
		TIMES ARG:1, 1.25
ENDSELECT
RETURN ARG:1


@DOWNBASE_CALCULATION, ARG, ARG:1
SELECTCASE (BASE:ARG:(ARG:1) * 100 / MAXBASE:ARG:(ARG:1))
CASE IS >= 98
	TIMES DOWNBASE:ARG:(ARG:1), 1.00
CASE IS >= 93
	TIMES DOWNBASE:ARG:(ARG:1), 0.99
CASE IS >= 88
	TIMES DOWNBASE:ARG:(ARG:1), 0.98
CASE IS >= 83
	TIMES DOWNBASE:ARG:(ARG:1), 0.97
CASE IS >= 78
	TIMES DOWNBASE:ARG:(ARG:1), 0.96
CASE IS >= 73
	TIMES DOWNBASE:ARG:(ARG:1), 0.95
CASE IS >= 68
	TIMES DOWNBASE:ARG:(ARG:1), 0.94
CASE IS >= 63
	TIMES DOWNBASE:ARG:(ARG:1), 0.93
CASE IS >= 59
	TIMES DOWNBASE:ARG:(ARG:1), 0.92
CASE IS >= 55
	TIMES DOWNBASE:ARG:(ARG:1), 0.91
CASE IS >= 51
	TIMES DOWNBASE:ARG:(ARG:1), 0.90
CASE IS >= 47
	TIMES DOWNBASE:ARG:(ARG:1), 0.89
CASE IS >= 43
	TIMES DOWNBASE:ARG:(ARG:1), 0.88
CASE IS >= 39
	TIMES DOWNBASE:ARG:(ARG:1), 0.87
CASE IS >= 35
	TIMES DOWNBASE:ARG:(ARG:1), 0.86
CASE IS >= 31
	TIMES DOWNBASE:ARG:(ARG:1), 0.85
CASE IS >= 27
	TIMES DOWNBASE:ARG:(ARG:1), 0.84
CASE IS >= 23
	TIMES DOWNBASE:ARG:(ARG:1), 0.83
CASE IS >= 19
	TIMES DOWNBASE:ARG:(ARG:1), 0.82
CASE IS >= 15
	TIMES DOWNBASE:ARG:(ARG:1), 0.81
CASE IS >= 12
	TIMES DOWNBASE:ARG:(ARG:1), 0.80
CASE IS >= 9
	TIMES DOWNBASE:ARG:(ARG:1), 0.79
CASE IS >= 6
	TIMES DOWNBASE:ARG:(ARG:1), 0.78
CASE IS >= 3
	TIMES DOWNBASE:ARG:(ARG:1), 0.77
CASE IS >= 0
	TIMES DOWNBASE:ARG:(ARG:1), 0.76
CASEELSE
	TIMES DOWNBASE:ARG:(ARG:1), 0.75
ENDSELECT
TIMES DOWNBASE:ARG:(ARG:1), 1.10

@MINUS_RAND_LOOP, ARG, ARG:1, ARG:2, ARG:3
SIF CFLAG:ARG:71 + CFLAG:ARG:72 + CFLAG:ARG:73 <= 0
	RETURN 0
$MINUS_RAND_LOOP
REPEAT 3
	LOCAL:COUNT = RAND:(ARG:1)
REND
SIF LOCAL:0 + LOCAL:1 + LOCAL:2 > ARG:2 && LOCAL:0 + LOCAL:1 + LOCAL:2 < ARG:3
	GOTO MINUS_RAND_LOOP
REPEAT 3
	CFLAG:ARG:(71 + COUNT) = MAX(CFLAG:ARG:(71 + COUNT) - LOCAL:COUNT, 0)
REND
RETURN LOCAL:1 + LOCAL:2 + LOCAL:3


@CALCULATE_LIMIT, ARG
REPEAT 3
	CFLAG:ARG:(71 + COUNT) = LIMIT(CFLAG:ARG:(71 + COUNT), 0, 10)
REND
IF CFLAG:ARG:3666 > 7
	$RAND_MINUS
	REPEAT 3
		LOCAL:COUNT = RAND:(CFLAG:ARG:3666 - 6)
		SIF CFLAG:ARG:(71 + COUNT) < LOCAL:COUNT
			GOTO RAND_MINUS
	REND
	IF LOCAL:0 - LOCAL:1 - LOCAL:2 <= CFLAG:ARG:3666 - 7
		REPEAT 3
			CFLAG:ARG:(71 + COUNT) = MAX(CFLAG:ARG:(71 + COUNT) - LOCAL:COUNT, 0)
		REND
	ELSE
		GOTO RAND_MINUS
	ENDIF
	CFLAG:ARG:3666 = 7
ENDIF