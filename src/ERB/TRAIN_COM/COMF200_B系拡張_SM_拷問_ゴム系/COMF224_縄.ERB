;=============================================================================
;縄
;=============================================================================
;--------------------------------------------------
;実行判定
;--------------------------------------------------
@COM_ABLE224
;個別設定コマンドフィルタ
SIF DITEMTYPE:999:224 > 0
	RETURN 0
;○○風呂入浴中はダメ
SIF TEQUIP:特殊風呂入浴中
	RETURN 0
;触手調教中はダメ
SIF TEQUIP:触手調教
	RETURN 0
;解除は乗馬中以外ならいつでも可能
SIF TEQUIP:緊縛関連 && TEQUIP:緊縛関連 < 5 && TEQUIP:三角木馬乗馬中 == 0
	RETURN 1
;アイテムを持っていないとダメ
SIF ITEM:縄 == 0
	RETURN 0
;助手は技巧5でないとダメ
IF ASSIPLAY
	SIF ABL:ASSI:技巧 < 5
		RETURN 0
;調教者の技巧が3無いとできない
ELSE
	SIF ABL:PLAYER:技巧 < 3
		RETURN 0
ENDIF
;荊で緊縛中、蜘蛛の糸で緊縛中はダメ
SIF TEQUIP:緊縛関連 >= 5 && TEQUIP:緊縛関連 <= 7
	RETURN 0
;お医者さんプレイ中はダメ
SIF TEQUIP:お医者さんプレイ
	RETURN 0
;コスプレ中はダメ
SIF TEQUIP:コスチュームプレイ > 2
	RETURN 0
;スク水プレイ中はダメ
SIF TEQUIP:コスチュームプレイ == 2
	RETURN 0
;距離のチェック
SIF EQUIP:戦闘中 && COM_ABLE_BATTLE(TARGET, PLAYER, 224) == 0
	RETURN 0
RETURN 1

;--------------------------------------------------
;コマンド本体
;--------------------------------------------------
@COM224
;………………………………………………
;コマンドの派生判定
;………………………………………………
;CONFIGで拷問系、精神操作系コマンドが有効で、
;これから奴隷を緊縛する場合、縛り方を選択することができる。
IF (TEQUIP:緊縛関連 == 0 || GROUPMATCH(TEQUIP:緊縛関連, 8, 9)) && FLAG:15 & 16
	CALL SELECT_ROPE
	SELECTCASE RESULT
		CASE 1
			JUMP COM622
		CASE 2
			JUMP COM623
		CASE 3
			JUMP COM624
	ENDSELECT
ENDIF

IF TEQUIP:緊縛関連 && !GROUPMATCH(TEQUIP:緊縛関連, 8, 9)
	PRINTL 縄解放

	;戦闘判定
	CALL COM_TRY_BATTLE, 224
	;実行できない
	SIF RESULT == 1
		RETURN 1

	TSTR:0 = 縄解放
ELSE
	PRINTL 縄

	;戦闘判定
	CALL COM_TRY_BATTLE, 224
	;実行できない
	SIF RESULT == 1
		RETURN 1

	TSTR:0 = 縄
ENDIF
CALL DISPLAY_KOJO_TRAIN_MESSAGE_F_COM

;緊縛経験が高いと消費減少
IF EXP:緊縛経験 < EXPLV:3
	DOWNBASE:0 += 100
	DOWNBASE:1 += 150
ELSEIF EXP:緊縛経験 < EXPLV:4
	DOWNBASE:0 += 80
	DOWNBASE:1 += 120
ELSE
	DOWNBASE:0 += 60
	DOWNBASE:1 += 90
ENDIF

LOCAL:1 = 250
SOURCE:痛み = 800
SOURCE:露出 = 800
SOURCE:屈従 = 500
SOURCE:逸脱 = 500

;PALAM:欲情をみる
IF PALAM:欲情 < PALAMLV:1
	TIMES LOCAL:1 , 0.80
ELSEIF PALAM:欲情 < PALAMLV:2
	TIMES LOCAL:1 , 0.90
ELSEIF PALAM:欲情 < PALAMLV:3
	TIMES LOCAL:1 , 1.00
ELSEIF PALAM:欲情 < PALAMLV:4
	TIMES LOCAL:1 , 1.10
ELSE
	TIMES LOCAL:1 , 1.20
ENDIF

;ABL:従順をみる
IF ABL:従順 == 0
	TIMES LOCAL:1 , 0.40
ELSEIF ABL:従順 == 1
	TIMES LOCAL:1 , 0.60
ELSEIF ABL:従順 == 2
	TIMES LOCAL:1 , 0.80
ELSEIF ABL:従順 == 3
	TIMES LOCAL:1 , 1.00
ELSEIF ABL:従順 == 4
	TIMES LOCAL:1 , 1.10
ELSE
	TIMES LOCAL:1 , 1.20
ENDIF

;ABL:マゾっ気をみる
IF ABL:マゾっ気 == 0
	TIMES LOCAL:1 , 0.80
ELSEIF ABL:マゾっ気 == 1
	TIMES LOCAL:1 , 1.00
ELSEIF ABL:マゾっ気 == 2
	TIMES LOCAL:1 , 1.30
ELSEIF ABL:マゾっ気 == 3
	TIMES LOCAL:1 , 1.60
ELSEIF ABL:マゾっ気 == 4
	TIMES LOCAL:1 , 2.00
ELSE
	TIMES LOCAL:1 , 3.00
ENDIF

;倒錯的
SIF TALENT:倒錯的
	TIMES LOCAL:1 , 2.00

SOURCE:痛み += LOCAL:1
SOURCE:露出 += LOCAL:1
SOURCE:屈従 += LOCAL:1
SOURCE:逸脱 += LOCAL:1

TCVAR:緊縛経験 += 5

;縄の着脱
IF TEQUIP:触手調教
	IF TEQUIP:緊縛関連 && !GROUPMATCH(TEQUIP:緊縛関連, 8, 9)
		TEQUIP:緊縛関連 = 0
	ELSE
		TEQUIP:緊縛関連 = 1
		STAIN:手 |= 2
		STAIN:手 |= 4
		STAIN:胸 |= 2
		STAIN:胸 |= 4
	ENDIF
ELSE
	IF TEQUIP:緊縛関連 && !GROUPMATCH(TEQUIP:緊縛関連, 8, 9)
		TEQUIP:緊縛関連 = 0
	ELSE
		TEQUIP:緊縛関連 = 1
		;ＳＭ教育経験フラグ
		SIF ASSIPLAY
			TFLAG:55 = 2
	ENDIF
ENDIF

;コマンド属性：触手
IF TEQUIP:触手調教
	TFLAG:98 = 8
;コマンド属性：道具(調教者)
ELSE
	TFLAG:98 = 1
ENDIF
RETURN 1

;-------------------------------------------------
;縄の縛り方選択
;-------------------------------------------------
@SELECT_ROPE
PRINTL 縛り方を決めてください
DRAWLINE
PRINTL [0]-普通に縛る
PRINTL [1]-四肢緊縛
;調教者の技巧Lvが3以上ある場合
SIF ABL:PLAYER:技巧 >= 3
	PRINTL [2]-亀甲縛り
;調教者がサドかドＳか技巧Lvが4以上ある場合
SIF ABL:PLAYER:技巧 >= 4 || TALENT:PLAYER:サド || TALENT:PLAYER:ドＳ
	PRINTL [3]-吊り下げ
$INPUT_LOOP
INPUT
IF RESULT == 0
	RETURN 0
ELSEIF RESULT == 1
	RETURN 1
ELSEIF RESULT == 2 && ABL:PLAYER:技巧 >= 3
	RETURN 2
ELSEIF RESULT == 3 && (ABL:PLAYER:技巧 >= 4 || TALENT:PLAYER:サド || TALENT:PLAYER:ドＳ)
	RETURN 3
ELSE
	CLEARLINE 1
	REUSELASTLINE
	GOTO INPUT_LOOP
ENDIF

;-------------------------------------------------
;縄で緊縛中
;-------------------------------------------------
@EQUIP_COM224
IF TEQUIP:触手調教
	PRINTL ＜触手緊縛中＞
ELSE
	PRINTL ＜緊縛中＞
ENDIF

;緊縛経験が高いと消費減少
IF EXP:緊縛経験 < EXPLV:3
	DOWNBASE:0 += 50
	DOWNBASE:1 += 100
ELSEIF EXP:緊縛経験 < EXPLV:4
	DOWNBASE:0 += 40
	DOWNBASE:1 += 80
ELSE
	DOWNBASE:0 += 30
	DOWNBASE:1 += 60
ENDIF

;ABL:マゾっ気をみる
IF ABL:マゾっ気 == 0
	LOCAL = 60
ELSEIF ABL:マゾっ気 == 1
	LOCAL = 180
ELSEIF ABL:マゾっ気 == 2
	LOCAL = 300
ELSEIF ABL:マゾっ気 == 3
	LOCAL = 480
ELSEIF ABL:マゾっ気 == 4
	LOCAL = 700
ELSE
	LOCAL = 850
ENDIF

;倒錯的
SIF TALENT:倒錯的
	TIMES LOCAL , 2.00

;PALAM:欲情をみる
IF PALAM:欲情 < PALAMLV:1
	TIMES LOCAL , 0.80
ELSEIF PALAM:欲情 < PALAMLV:2
	TIMES LOCAL , 0.90
ELSEIF PALAM:欲情 < PALAMLV:3
	TIMES LOCAL , 1.00
ELSEIF PALAM:欲情 < PALAMLV:4
	TIMES LOCAL , 1.10
ELSE
	TIMES LOCAL , 1.20
ENDIF

SOURCE:痛み += LOCAL
SOURCE:露出 += LOCAL
SOURCE:屈従 += LOCAL
SOURCE:逸脱 += LOCAL

IF TALENT:オトコ == 0 && TALENT:PLAYER:オトコ == 0
	TCVAR:レズ経験 += 1
ELSEIF TALENT:オトコ && TALENT:PLAYER:オトコ
	TCVAR:ＢＬ経験 += 1
ENDIF
;主人経験フラグ
SIF ASSIPLAY == 0 && ABL:マゾっ気 >= 2
	TFLAG:50 += 1
;触手経験フラグ
SIF TEQUIP:触手調教
	TFLAG:90 += 1

TCVAR:緊縛経験 += 2

RETURN 1

;--------------------------------------------------
;調教時メッセージ
;--------------------------------------------------
@SYSTXT_TRAIN_MESSAGE_F_COM_224
PRINTFORM %CALLNAME:PLAYER%は、
IF TEQUIP:緊縛関連 && !GROUPMATCH(TEQUIP:緊縛関連, 8, 9)
	PRINTFORML %CALLNAME:TARGET%の縄をほどいてやった…
ELSE
	IF TFLAG:899 == 0
		;倒錯的で恐怖刻印が1以下で反発刻印がないとき
		IF TALENT:倒錯的 && MARK:恐怖刻印 < 2 && MARK:反発刻印 < 1
			PRINTFORML %CALLNAME:TARGET%を縄で縛った。
			PRINTFORML %CALLNAME:TARGET%は縄の感触を全身に受けて、快感を心行くまで味わっているようだ…
		;反抗的か抵抗を持ち陥落してない場合
		ELSEIF (TALENT:反抗的 || TALENT:抵抗) && TALENT:恋慕 == 0 && TALENT:服従 == 0 && TALENT:淫乱 == 0
			PRINTFORML 激しく嫌がる%CALLNAME:TARGET%を強引に縄で縛り付けた…
		;臆病持ちか恐怖刻印2以上で気丈と感情乏しいを持たず、陥落していない場合
		ELSEIF (TALENT:臆病 || MARK:恐怖刻印 >= 2) && TALENT:気丈 == 0 && TALENT:感情乏しい == 0 && TALENT:恋慕 == 0 && TALENT:服従 == 0 && TALENT:淫乱 == 0
			PRINTFORML 恐怖に怯える%CALLNAME:TARGET%を縄で丁寧に縛った…
		;プライド高いか神霊でなおかつ、屈服刻印と恥辱刻印が1以下で、陥落していない場合
		ELSEIF (TALENT:プライド高い || TALENT:神霊) && MARK:屈服刻印 < 2 && MARK:恥辱刻印 < 2 && TALENT:恋慕 == 0 && TALENT:服従 == 0 && TALENT:淫乱 == 0
			PRINTFORML %CALLNAME:TARGET%を縄で縛った。
			PRINTFORML %CALLNAME:TARGET%は縛られながらも、そのプライドだけは折れてはいないように見えた…
		;解放か快感に素直か春の人で痛みに弱いがなく、反発刻印がない場合
		ELSEIF (TALENT:解放 || TALENT:快感に素直 || TALENT:春の人) && TALENT:痛みに弱い == 0 && MARK:反発刻印 <= 0
			PRINTFORML なんだか楽しそうな%CALLNAME:TARGET%を縄で丁寧に縛った…
		ELSE
			PRINTFORML %CALLNAME:TARGET%を縄で縛った…
		ENDIF
	ELSE
		PRINTFORML %CALLNAME:TARGET%を縄で縛った…
	ENDIF
ENDIF
