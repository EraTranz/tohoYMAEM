;=============================================================================
;鈴蘭の毒
;=============================================================================
;--------------------------------------------------
;実行判定
;--------------------------------------------------
@COM_ABLE420
;個別設定コマンドフィルタ
SIF DITEMTYPE:999:420 > 0
	RETURN 0
;キャラ専用コマンドを有効にしてないとダメ
SIF (FLAG:15 & 16384) == 0
	RETURN 0
;調教者がメディスンじゃないとダメ
SIF NO:PLAYER != 1033
	RETURN 0
;薬毒耐性だとダメ。ただし[人形]は除く
SIF TALENT:薬毒耐性 && TALENT:淫乳 == 0
	RETURN 0
;体力が1000未満では使用不可
SIF BASE:体力 < 1000 && !(FLAG:16 & 32)
	RETURN 0
;使いすぎるとダメ
SIF CFLAG:33 >= 1000
	RETURN 0
;睡眠中は不可
SIF EQUIP:睡眠薬
	RETURN 0
;失神中は不可
SIF TFLAG:899 > 0
	RETURN 0
;鈴蘭の毒効果発揮中は不可
SIF TEQUIP:鈴蘭の毒
	RETURN 0
;触手調教中はダメ
SIF TEQUIP:触手調教
	RETURN 0
;距離のチェック
SIF EQUIP:戦闘中 && COM_ABLE_BATTLE(TARGET, PLAYER, 420) == 0
	RETURN 0
RETURN 1

;--------------------------------------------------
;コマンド本体
;--------------------------------------------------
@COM420
PRINTL 鈴蘭の毒

;戦闘判定
CALL COM_TRY_BATTLE, 420
;実行できない
SIF RESULT == 1
	RETURN 1

TSTR:0 = 鈴蘭の毒

LOCAL:1 = RAND:16
TFLAG:99 = LOCAL:1
LOCAL:2 = CFLAG:33
CALL DISPLAY_KOJO_TRAIN_MESSAGE_F_COM

DOWNBASE:0 += 50 + (50 * (16-LOCAL:1) / (LOCAL:2+1))
DOWNBASE:1 += 30 + (30 * (16-LOCAL:1) / (LOCAL:2+1))

SOURCE:痛み = 3000
SOURCE:薬物浸潤 = 3500
SOURCE:逸脱 = 8000

TEQUIP:鈴蘭の毒 = 1

IF LOCAL:1 == 0 && CFLAG:33 == 0
	CALL POISON_EFFECT
ELSEIF LOCAL:1 == 0 && CFLAG:33 > 0
	SIF BASE:体力 > 10
		BASE:体力 = 10
ELSEIF LOCAL:1 >= 1 && LOCAL:1 < 4
	PALAM:恭順 += 5000
	PALAM:屈服 += 5000
	PALAM:反感 /= 2
ELSEIF LOCAL:1 >= 4 && LOCAL:1 < 8
	PALAM:潤滑 += 5000
	PALAM:欲情 += 5000
	PALAM:恥情 += 5000
ELSEIF LOCAL:1 >= 8 && LOCAL:1 < 12
	PALAM:恐怖 += 5000
ELSE
	PALAM:苦痛 += 5000
	PALAM:不快 += 5000
ENDIF

CFLAG:33 += 10 + RAND:11

IF TALENT:オトコ == 0 && TALENT:PLAYER:オトコ == 0
	TCVAR:レズ経験 += 1
ELSEIF TALENT:オトコ && TALENT:PLAYER:オトコ
	TCVAR:ＢＬ経験 += 1
ENDIF

;薬物経験
TCVAR:薬物経験 += 3
RETURN 1

;--------------------------------------------------
;鈴蘭の毒効果発揮中
;--------------------------------------------------
@EQUIP_COM420
PRINTL ＜鈴蘭の毒効果発揮中＞

DOWNBASE:0 += 100
DOWNBASE:1 += 90

LOCAL = 1
SIF CFLAG:33 / 10 > 0
	LOCAL += CFLAG:33 / 10
SOURCE:痛み += 2500 / LOCAL
SOURCE:薬物浸潤 += 500

CFLAG:33 -= RAND:5

LOCAL:1 = 100
;[蓬莱人]、[霊体]は早めに耐性が付く
SIF TALENT:蓬莱人 || TALENT:霊体
	TIMES LOCAL:1 , 0.50
;[神霊]、[半神]、[死神]も同じく耐性が早めに付く
SIF TALENT:神霊 || TALENT:半神 || TALENT:死神
	TIMES LOCAL:1 , 0.66
;異常経験が多いと同じく早めに耐性が付く
SIF EXP:異常経験 >= 5
	TIMES LOCAL:1 , 0.75
;中毒しやすいだと耐性が付きにくい
SIF TALENT:中毒しやすい
	TIMES LOCAL:1 , 2.00

IF CFLAG:33 >= LOCAL:1
	IF RAND:8 == 0 && TALENT:薬毒耐性 == 0
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 20
		PRINTFORML %CALLNAME:TARGET%は鈴蘭の毒に対する耐性を手に入れた
		PRINTFORML %CALLNAME:TARGET%は[薬毒耐性]を得た
		TALENT:薬毒耐性 = 1
	ELSE
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 19
		PRINTFORML %CALLNAME:TARGET%は鈴蘭の毒に対する耐性を手に入れた
	ENDIF
	CFLAG:33 += 1000
ENDIF

;--------------------------------------------------
;毒の効果
;--------------------------------------------------
@POISON_EFFECT
#LOCALSIZE 1
LOCAL = RAND:10
IF LOCAL == 0 && TALENT:臆病 == 0
	CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 0
	PRINTFORML %CALLNAME:TARGET%は[臆病]を得た
	TALENT:臆病 = 1
	CFLAG:12 |= 4
ELSEIF LOCAL == 1 && TALENT:感情乏しい == 0
	CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 1
	PRINTFORML %CALLNAME:TARGET%は[感情乏しい]を得た
	TALENT:感情乏しい = 1
	CFLAG:12 |= 8
ELSEIF LOCAL == 2
	IF CFLAG:12 & 16 || CFLAG:12 & 32
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 2
		PRINTFORML %CALLNAME:TARGET%の気力が消耗した
		BASE:気力 = MAX(BASE:気力 - 200, 0)
	ELSEIF TALENT:楽観的
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 3
		PRINTFORML %CALLNAME:TARGET%は[楽観的]を失い、[悲観的]を得た
		TALENT:楽観的 = 0
		TALENT:悲観的 = 1
		CFLAG:12 |= 16
	ELSEIF TALENT:悲観的
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 4
		PRINTFORML %CALLNAME:TARGET%は[悲観的]を失い、[楽観的]を得た
		TALENT:楽観的 = 1
		TALENT:悲観的 = 0
		CFLAG:12 |= 32
	ELSE
		SELECTCASE RAND:2
			CASE 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 3
				PRINTFORML %CALLNAME:TARGET%は物事を悲観的に考えるようになった
				PRINTFORML %CALLNAME:TARGET%は[悲観的]を得た
				TALENT:悲観的 = 1
				CFLAG:12 |= 16
			CASEELSE
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 4
				PRINTFORML %CALLNAME:TARGET%は物事を楽観的に考えるようになった
				PRINTFORML %CALLNAME:TARGET%は[楽観的]を得た
				TALENT:楽観的 = 1
				CFLAG:12 |= 32
		ENDSELECT
	ENDIF
ELSEIF LOCAL == 3 && TALENT:目立ちたがり == 0 && TALENT:抑圧 == 0
	SELECTCASE RAND:2
		CASE 0
			CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 5
			PRINTFORML %CALLNAME:TARGET%は[目立ちたがり]を得た
			TALENT:目立ちたがり = 1
			CFLAG:12 |= 64
		CASEELSE
			CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 6
			PRINTFORML %CALLNAME:TARGET%は[抑圧]を得た
			TALENT:抑圧 = 1
			CFLAG:12 |= 128
	ENDSELECT
ELSEIF LOCAL == 4 && TALENT:汚れ無視
	IF CFLAG:12 & 256 || CFLAG:12 & 512
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET,7, 2
		PRINTFORML %CALLNAME:TARGET%の気力が消耗した
		BASE:気力 = MAX(BASE:気力 - 200, 0)
	ELSEIF TALENT:汚臭鈍感
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 7
		PRINTFORML %CALLNAME:TARGET%は[汚臭鈍感]を失い、[汚臭敏感]を得た
		TALENT:汚臭鈍感 = 0
		TALENT:汚臭敏感 = 1
		CFLAG:12 |= 256
	ELSEIF TALENT:汚臭敏感
		CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 8
		PRINTFORML %CALLNAME:TARGET%は[汚臭敏感]を失い、[汚臭鈍感]を得た
		TALENT:汚臭鈍感 = 1
		TALENT:汚臭敏感 = 0
		CFLAG:12 |= 512
	ELSE
		SELECTCASE RAND:2
			CASE 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 7
				PRINTFORML %CALLNAME:TARGET%は[汚臭敏感]を得た
				TALENT:汚臭敏感 = 1
				CFLAG:12 |= 256
			CASEELSE
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 8
				PRINTFORML %CALLNAME:TARGET%は[汚臭鈍感]を得た
				TALENT:汚臭鈍感 = 1
				CFLAG:12 |= 512
		ENDSELECT
	ENDIF
ELSEIF LOCAL == 5
	SELECTCASE RAND:2
		CASE 0
			IF TALENT:Ｃ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7 ,9
				PRINTFORML %CALLNAME:TARGET%は[Ｃ鈍感]を失った
				TALENT:Ｃ鈍感 = 0
			ELSEIF TALENT:Ｃ鈍感 == 0 && TALENT:Ｃ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 9
				PRINTFORML %CALLNAME:TARGET%は[Ｃ敏感]を得た
				TALENT:Ｃ敏感 = 1
			ELSEIF TALENT:Ｃ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 10
				PRINTFORML %CALLNAME:TARGET%は[Ｃ敏感]を失った
				TALENT:Ｃ敏感 = 0
			ENDIF
		CASEELSE
			IF TALENT:Ｃ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 10
				PRINTFORML %CALLNAME:TARGET%は[Ｃ敏感]を失った
				TALENT:Ｃ敏感 = 0
			ELSEIF TALENT:Ｃ鈍感 == 0 && TALENT:Ｃ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 10
				PRINTFORML %CALLNAME:TARGET%は[Ｃ鈍感]を得た
				TALENT:Ｃ鈍感 = 1
			ELSEIF TALENT:Ｃ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 9
				PRINTFORML %CALLNAME:TARGET%は[Ｃ鈍感]を失った
				TALENT:Ｃ鈍感 = 0
			ENDIF
	ENDSELECT
ELSEIF LOCAL == 6 && TALENT:オトコ == 0
	SELECTCASE RAND:2
		CASE 0
			IF TALENT:Ｖ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 11
				PRINTFORML %CALLNAME:TARGET%は[Ｖ鈍感]を失った
				TALENT:Ｖ鈍感 = 0
			ELSEIF TALENT:Ｖ鈍感 == 0 && TALENT:Ｖ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 11
				PRINTFORML %CALLNAME:TARGET%は[Ｖ敏感]を得た
				TALENT:Ｖ敏感 = 1
			ELSEIF TALENT:Ｖ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 12
				PRINTFORML %CALLNAME:TARGET%は[Ｖ敏感]を失った
				TALENT:Ｖ敏感 = 0
			ENDIF
		CASEELSE
			IF TALENT:Ｖ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 12
				PRINTFORML %CALLNAME:TARGET%は[Ｖ敏感]を失った
				TALENT:Ｖ敏感 = 0
			ELSEIF TALENT:Ｖ鈍感 == 0 && TALENT:Ｖ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 12
				PRINTFORML %CALLNAME:TARGET%は[Ｖ鈍感]を得た
				TALENT:Ｖ鈍感 = 1
			ELSEIF TALENT:Ｖ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 11
				PRINTFORML %CALLNAME:TARGET%は[Ｖ鈍感]を失った
				TALENT:Ｖ鈍感 = 0
			ENDIF
	ENDSELECT
ELSEIF LOCAL == 7
	SELECTCASE RAND:2
		CASE 0
			IF TALENT:Ａ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 13
				PRINTFORML %CALLNAME:TARGET%は[Ａ鈍感]を失った
				TALENT:Ａ鈍感 = 0
			ELSEIF TALENT:Ａ鈍感 == 0 && TALENT:Ａ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 13
				PRINTFORML %CALLNAME:TARGET%は[Ａ敏感]を得た
				TALENT:Ａ敏感 = 1
			ELSEIF TALENT:Ａ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 14
				PRINTFORML %CALLNAME:TARGET%は[Ａ敏感]を失った
				TALENT:Ａ敏感 = 0
			ENDIF
		CASEELSE
			IF TALENT:Ａ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 14
				PRINTFORML %CALLNAME:TARGET%は[Ａ敏感]を失った
				TALENT:Ａ敏感 = 0
			ELSEIF TALENT:Ａ鈍感 == 0 && TALENT:Ａ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 14
				PRINTFORML %CALLNAME:TARGET%は[Ａ鈍感]を得た
				TALENT:Ａ鈍感 = 1
			ELSEIF TALENT:Ａ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 13
				PRINTFORML %CALLNAME:TARGET%は[Ａ鈍感]を失った
				TALENT:Ａ鈍感 = 0
			ENDIF
	ENDSELECT
ELSEIF LOCAL == 8
	SELECTCASE RAND:2
		CASE 0
			IF TALENT:Ｂ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 15
				PRINTFORML %CALLNAME:TARGET%は[Ｂ鈍感]を失った
				TALENT:Ｂ鈍感 = 0
			ELSEIF TALENT:Ｂ鈍感 == 0 && TALENT:Ｂ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 15
				PRINTFORML %CALLNAME:TARGET%は[Ｂ敏感]を得た
				TALENT:Ｂ敏感 = 1
			ELSEIF TALENT:Ｂ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 16
				PRINTFORML %CALLNAME:TARGET%は[Ｂ敏感]を失った
				TALENT:Ｂ敏感 = 0
			ENDIF
		CASEELSE
			IF TALENT:Ｂ敏感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 16
				PRINTFORML %CALLNAME:TARGET%は[Ｂ敏感]を失った
				TALENT:Ｂ敏感 = 0
			ELSEIF TALENT:Ｂ鈍感 == 0 && TALENT:Ｂ敏感 == 0
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 16
				PRINTFORML %CALLNAME:TARGET%は[Ｂ鈍感]を得た
				TALENT:Ｂ鈍感 = 1
			ELSEIF TALENT:Ｂ鈍感
				CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 15
				PRINTFORML %CALLNAME:TARGET%は[Ｂ鈍感]を失った
				TALENT:Ｂ鈍感 = 0
			ENDIF
	ENDSELECT
ELSEIF LOCAL == 9 && TALENT:回復遅い != 1
	CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 17
	IF TALENT:回復早い
		PRINTFORML %CALLNAME:TARGET%は[回復早い]を失った
		TALENT:回復早い = 0
	ELSEIF TALENT:回復遅い == 0
		PRINTFORML %CALLNAME:TARGET%は[回復遅い]を得た
		TALENT:回復遅い = 1
	ENDIF
ELSE
	CALL DISPLAY_KOJO_MESSAGE_SUB_EVENT, TARGET, 7, 18
	PRINTFORML %CALLNAME:TARGET%の体力と気力の最大値が低下した
	MAXBASE:0 -= 100
	MAXBASE:1 -= 100
	BASE:体力 = MIN(BASE:体力, 10)
	BASE:気力 = MAX(BASE:気力, 0)
ENDIF

CFLAG:33 += 50
RETURN 1

;--------------------------------------------------
;調教時メッセージ
;--------------------------------------------------
@SYSTXT_TRAIN_MESSAGE_F_COM_420
PRINTFORML %CALLNAME:PLAYER%は%CALLNAME:TARGET%に鈴蘭の毒を浴びせた
IF TFLAG:99 == 0 && CFLAG:33 > 0
	PRINTFORML %CALLNAME:TARGET%は毒で体力を消耗している……
ELSEIF TFLAG:99 >= 1 && TFLAG:99 < 4
	PRINTFORML %CALLNAME:TARGET%は虚ろな目つきで%CALLNAME:PLAYER%を見上げている
	PRINTFORML その瞳からは反抗する意思が感じられない……
ELSEIF TFLAG:99 >= 4 && TFLAG:99 < 8
	PRINTFORML 毒の影響か%CALLNAME:TARGET%は顔を紅潮させ、息を荒げている……
ELSEIF TFLAG:99 >= 8 && TFLAG:99 < 12
	PRINTFORML %CALLNAME:PLAYER%と目が合うと%CALLNAME:TARGET%は急に怯えた様子で逃げ出そうとした……
ELSE
	PRINTFORML %CALLNAME:TARGET%は気分が悪いのか顔面蒼白になり、口元に手を当てている……
ENDIF
