;=============================================================================
;口移し
;=============================================================================
;特定の風呂に浸かっているかつ純愛モード有効の場合、キスを使うとこのコマンドに
;純愛なのかどうかかなり微妙でもあるが
;--------------------------------------------------
;コマンド本体
;--------------------------------------------------
@COM621
IF TEQUIP:特殊風呂入浴中 == 3
	LOCALS = 口移し(ローション)
	TFLAG:148 = 1
ELSEIF TEQUIP:特殊風呂入浴中 == 5 || TEQUIP:特殊風呂入浴中 == 6
	LOCALS = 口移し(媚薬)
	TFLAG:148 = 2
ELSEIF TEQUIP:特殊風呂入浴中 == 8
	LOCALS = 口移し(精液)
	TFLAG:148 = 3
ELSEIF TEQUIP:特殊風呂入浴中 == 9 || TEQUIP:特殊風呂入浴中 == 17
	LOCALS = 口移し(酒)
	TFLAG:148 = 4
ELSEIF TEQUIP:特殊風呂入浴中 == 10
	LOCALS = 口移し(トロロ)
	TFLAG:148 = 5
ELSEIF TEQUIP:特殊風呂入浴中 == 13
	LOCALS = 口移し(国士無双の薬)
	TFLAG:148 = 6
ELSEIF TEQUIP:特殊風呂入浴中 == 14
	LOCALS = 口移し(厄毒)
	TFLAG:148 = 7
ELSE
	LOCALS = 口移し
	TFLAG:148 =0
ENDIF
PRINTFORML %LOCALS%

;-------------------------------------------------
;実行できるかの判定
;-------------------------------------------------
;戦闘判定
CALL COM_TRY_BATTLE, 621
;実行できない
SIF RESULT == 1
	RETURN 1

IF TFLAG:699 == 0
	CALL COM_ORDER,621
	;実行できない
	SIF RESULT == 0
		RETURN 0
ENDIF

;-------------------------------------------------
;実行決定
;-------------------------------------------------
TSTR:0 = %LOCALS%
SELECTCASE TFLAG:148
	CASE 1
		DOWNBASE:0 += 25
		DOWNBASE:1 += 100
	CASE 2
		DOWNBASE:0 += 30
		DOWNBASE:1 += 120
	CASE 3
		DOWNBASE:0 += 40
		DOWNBASE:1 += 160
	CASE 4
		DOWNBASE:0 += 20
		DOWNBASE:1 += 80
	CASE 5
		DOWNBASE:0 += 30
		DOWNBASE:1 += 90
	CASE 6
		DOWNBASE:0 += 40
		DOWNBASE:1 += 120
	CASE 7
		DOWNBASE:0 += 60
		DOWNBASE:1 += 150
	CASEELSE
		DOWNBASE:0 += 10
		DOWNBASE:1 += 40
ENDSELECT
SELECTCOM = 621
CALL DISPLAY_KOJO_TRAIN_MESSAGE_F_COM

;-------------------------------------------------
;射精ゲージチェック（ふたなり・オトコの場合）
;-------------------------------------------------
LOCAL = 0

;ABL:技巧をみる
IF ABL:技巧 == 0
	LOCAL = 50
ELSEIF ABL:技巧 == 1
	LOCAL = 100
ELSEIF ABL:技巧 == 2
	LOCAL = 150
ELSEIF ABL:技巧 == 3
	LOCAL = 250
ELSEIF ABL:技巧 == 4
	LOCAL = 380
ELSE
	LOCAL = 500
ENDIF

;従順をみる
LOCAL = EJACULATIONCHECK_ABL_10_1(TARGET, LOCAL)
;奉仕精神をみる
LOCAL = EJACULATIONCHECK_ABL_13_1(TARGET, LOCAL)

;TALENT:舌使いをみる
SIF TALENT:舌使い
	TIMES LOCAL , 2.00
;猫舌をみる
SIF TALENT:猫舌
	TIMES LOCAL , 0.70
;睡眠薬で寝ているor失神している場合
SIF EQUIP:睡眠薬 || TFLAG:899 > 0
	TIMES LOCAL, 0.7

;調教者のＣ感覚をみる
LOCAL = EJACULATIONCHECK_ABL_0_1(PLAYER, LOCAL)

SIF EXIST_PENIS(PLAYER)
	BASE:PLAYER:射精 += LOCAL

;-------------------------------------------------
;ソースの計算
;-------------------------------------------------
SELECTCASE TFLAG:148
	CASE 1
		;ローション
		SOURCE:性行動 = 100
		SOURCE:露出 = 300
		SOURCE:逸脱 = 500
		;助手調教の場合
		IF ASSIPLAY
			JUEL:ASSI:4 += 20
			JUEL:ASSI:7 += 20
			JUEL:ASSI:否定 += 10
		ENDIF
	CASE 2
		;媚薬
		SOURCE:欲情追加 = 2000
		SOURCE:逸脱 = 3000
		;媚薬中毒
		IF TALENT:媚薬中毒
			SOURCE:中毒充足 = 500
			TIMES SOURCE:欲情追加 , 1.50
			TIMES SOURCE:逸脱 , 1.50
			SOURCE:媚薬浸潤 = 50
		ELSE
			SOURCE:媚薬浸潤 = 1 + RAND:3
		ENDIF
		;助手調教の場合
		IF ASSIPLAY
			JUEL:ASSI:5 += 20
			JUEL:ASSI:否定 += 100
			;媚薬中毒
			IF TALENT:ASSI:媚薬中毒
				JUEL:ASSI:4 += 10
				JUEL:ASSI:5 += 30
				JUEL:ASSI:否定 -= 50
				SOURCE:ASSI:媚薬浸潤 = 50
			ELSE
				SOURCE:ASSI:媚薬浸潤 = 1 + RAND:3
			ENDIF
		ENDIF
		;口移しされる方の薬物経験
		TCVAR:PLAYER:薬物経験 += 1
	CASE 3
		;精液
		;ABL:精液中毒をみる
		IF ABL:精液中毒 == 0
			TFLAG:242 += 12
			SOURCE:中毒充足 = 0
			SOURCE:屈従 = 9000
			SOURCE:逸脱 = 15000
		ELSEIF ABL:精液中毒 == 1
			TFLAG:242 += 8
			SOURCE:中毒充足 = 300
			SOURCE:屈従 = 6000
			SOURCE:逸脱 = 9000
		ELSEIF ABL:精液中毒 == 2
			TFLAG:242 += 5
			SOURCE:中毒充足 = 900
			SOURCE:屈従 = 3000
			SOURCE:逸脱 = 4000
		ELSEIF ABL:精液中毒 == 3
			TFLAG:242 += 3
			SOURCE:中毒充足 = 1800
			SOURCE:屈従 = 1500
			SOURCE:逸脱 = 2000
		ELSEIF ABL:精液中毒 == 4
			TFLAG:242 += 2
			SOURCE:中毒充足 = 3800
			SOURCE:屈従 = 800
			SOURCE:逸脱 = 1000
		ELSE
			TFLAG:242 += 1
			SOURCE:中毒充足 = 8200
			SOURCE:屈従 = 400
			SOURCE:逸脱 = 500
		ENDIF
		;助手調教の場合
		IF ASSIPLAY
			LOCAL:2 = ABL:欲望
			JUEL:ASSI:5 += LOCAL:2 * 20
			JUEL:ASSI:6 += (8 - LOCAL:2) * 20
			JUEL:ASSI:否定 += (6 - LOCAL:2) * 50
		ENDIF
		;精液を飲んだフラグ
		TFLAG:3 += 1
	CASE 4
		;酒
		SOURCE:欲情追加 = 500
		SOURCE:露出 = 500
		SOURCE:反感追加 = 400 * (1 + MARK:反発刻印)
		SOURCE:恭順追加 = 800
		;助手調教の場合
		IF ASSIPLAY
			IF TALENT:オトコ && TALENT:ASSI:オトコ
				LOCAL:2 = ABL:ＢＬ中毒
			ELSEIF TALENT:オトコ == 0 && TALENT:ASSI:オトコ == 0
				LOCAL:2 = ABL:レズ中毒
			ELSE
				LOCAL:2 = 0
			ENDIF
			IF LOCAL:2 > 0
				JUEL:ASSI:恭順 += LOCAL:2 * 30
				JUEL:ASSI:恥情 += (8 - LOCAL:2) * 40
			ENDIF
			JUEL:ASSI:否定 += (5 - LOCAL:2 + MARK:ASSI:反発刻印) * 50
		ENDIF
	CASE 5
		;トロロ
		SOURCE:露出 = 1000
		SOURCE:反感追加 = 150 * (1 + MARK:反発刻印)
		SOURCE:痒み = 500
		;助手調教の場合
		IF ASSIPLAY
			IF TALENT:オトコ && TALENT:ASSI:オトコ
				LOCAL:2 = ABL:ＢＬ中毒
			ELSEIF TALENT:オトコ == 0 && TALENT:ASSI:オトコ == 0
				LOCAL:2 = ABL:レズ中毒
			ELSE
				LOCAL:2 = 0
			ENDIF
			IF LOCAL:2 > 0
				JUEL:ASSI:恭順 += LOCAL:2 * 30
				JUEL:ASSI:恥情 += (8 - LOCAL:2) * 40
			ENDIF
			JUEL:ASSI:否定 += (5 - LOCAL:2 + MARK:ASSI:反発刻印) * 50
		ENDIF
	CASE 6
		;国士無双の薬
		SOURCE:中毒充足 = 500
		SOURCE:液体追加 = 1200
		SOURCE:欲情追加 = 750
		SOURCE:逸脱 = 900
		;口移しされる方の薬物経験
		TCVAR:PLAYER:薬物経験 += 3
	CASE 7
		;厄毒
		SOURCE:中毒充足 = 1300
		SOURCE:液体追加 = 200
		SOURCE:逸脱 = 1800
		SOURCE:支配 = 500
		SOURCE:痒み = 1700
		TFLAG:242 += 10
ENDSELECT

;上のほうで計算した汚れデータ
SOURCE:不潔 = TFLAG:242*20 + 10

;ABL:奉仕精神をみる
IF ABL:奉仕精神 == 0
	SOURCE:性行動 += 30
	SOURCE:達成感 = 0
	TIMES SOURCE:不潔 , 4.00
ELSEIF ABL:奉仕精神 == 1
	SOURCE:性行動 += 100
	SOURCE:達成感 = 30
	TIMES SOURCE:不潔 , 2.50
ELSEIF ABL:奉仕精神 == 2
	SOURCE:性行動 += 250
	SOURCE:達成感 = 80
	TIMES SOURCE:不潔 , 1.50
ELSEIF ABL:奉仕精神 == 3
	SOURCE:性行動 += 200
	SOURCE:達成感 = 150
	TIMES SOURCE:不潔 , 1.00
ELSEIF ABL:奉仕精神 == 4
	SOURCE:性行動 += 280
	SOURCE:達成感 = 240
	TIMES SOURCE:不潔 , 0.50
ELSE
	SOURCE:性行動 += 350
	SOURCE:達成感 = 480
	TIMES SOURCE:不潔 , 0.10
ENDIF

;ABL:技巧をみる
IF ABL:技巧 == 0
	TIMES SOURCE:性行動 , 0.50
	TIMES SOURCE:達成感 , 0.50
ELSEIF ABL:技巧 == 1
	TIMES SOURCE:性行動 , 0.80
	TIMES SOURCE:達成感 , 0.80
ELSEIF ABL:技巧 == 2
	TIMES SOURCE:性行動 , 1.00
	TIMES SOURCE:達成感 , 1.00
ELSEIF ABL:技巧 == 3
	TIMES SOURCE:性行動 , 1.50
	TIMES SOURCE:達成感 , 1.50
ELSEIF ABL:技巧 == 4
	TIMES SOURCE:性行動 , 2.50
	TIMES SOURCE:達成感 , 2.50
ELSE
	TIMES SOURCE:性行動 , 4.00
	TIMES SOURCE:達成感 , 4.00
ENDIF

;キス魔
IF TALENT:キス魔
	TIMES SOURCE:性行動 , 2.50
	TIMES SOURCE:達成感 , 2.50
ENDIF
;調教者が助手でキス魔だと技巧に応じて欲望を習得の珠が僅かに入る
IF TALENT:PLAYER:キス魔
	TIMES SOURCE:性行動 , 2.50
	TIMES SOURCE:達成感 , 2.50
	IF ASSIPLAY
		LOCAL:1 = ABL:PLAYER:技巧 + 1
		JUEL:PLAYER:習得 += LOCAL:1 * 25
		JUEL:PLAYER:欲情 += LOCAL:1 * 25
	ENDIF
ENDIF

;-------------------------------------------------
;射精チェック
;-------------------------------------------------
TFLAG:91 = SAMEN_CHECK(PLAYER)

IF TFLAG:91
;射精している
	TIMES SOURCE:性行動 , 3.00
	;ABL:精液中毒をみる
	IF ABL:精液中毒 == 0
		SOURCE:中毒充足 += 0
		TIMES SOURCE:達成感 , 2.00
		TIMES SOURCE:屈従, 2.00
	ELSEIF ABL:精液中毒 == 1
		SOURCE:中毒充足 += 100
		TIMES SOURCE:達成感 , 2.50
		TIMES SOURCE:屈従, 1.60
	ELSEIF ABL:精液中毒 == 2
		SOURCE:中毒充足 += 300
		TIMES SOURCE:達成感 , 3.00
		TIMES SOURCE:屈従, 1.00
	ELSEIF ABL:精液中毒 == 3
		SOURCE:中毒充足 += 700
		TIMES SOURCE:達成感 , 4.00
		TIMES SOURCE:屈従, 0.70
	ELSEIF ABL:精液中毒 == 4
		SOURCE:中毒充足 += 1500
		TIMES SOURCE:達成感 , 5.00
		TIMES SOURCE:屈従, 0.40
	ELSE
		SOURCE:中毒充足 += 6000
		TIMES SOURCE:達成感 , 6.00
		TIMES SOURCE:屈従, 0.10
	ENDIF

	;射精した人物を設定
	TFLAG:92 = PLAYER
	;射精された人物を設定
	TFLAG:94 = TARGET
	;このコマンドのデフォルト射精箇所タイプ、射精箇所選択の可・不可を設定
	CALL COM_SHOOT_621
	;汎用的な処理はこの関数で行う
	;（射精ゲージの再計算や射精経験の上昇と共通部分の表示）
	CALL SAMEN_SHOOT
ENDIF

;奴隷の口⇔調教者の口の汚れが移動
STAIN:口 |= STAIN:PLAYER:口
STAIN:PLAYER:口 |= STAIN:口

;キス経験
TCVAR:キス経験 += 1
TCVAR:PLAYER:キス経験 += 1
CFLAG:主人と調教キス数 += (ASSIPLAY == 0) ? 1 # 0

IF TALENT:オトコ == 0 && TALENT:PLAYER:オトコ == 0
	TCVAR:レズ経験 += 3
ELSEIF TALENT:オトコ && TALENT:PLAYER:オトコ
	TCVAR:ＢＬ経験 += 3
ENDIF
;奉仕快楽経験入手判定
TFLAG:100 |= 1

;国士無双の薬は爆発のチェックがある
IF TFLAG:148 == 6
	IF ASSIPLAY
		TFLAG:162 += 10
		SIF TFLAG:162 > 30
			CALL DOPING8556_BURST_ASSI
	ELSE
		TFLAG:161 += 10
		SIF TFLAG:161 > 30
			CALL DOPING8556_BURST_MASTER
	ENDIF
ENDIF
;主人経験フラグ
SIF ASSIPLAY == 0
	TFLAG:50 += 1
RETURN 1

;--------------------------------------------------
;調教時メッセージ
;--------------------------------------------------
@SYSTXT_TRAIN_MESSAGE_F_COM_621
PRINTFORM %CALLNAME:TARGET%は浴槽内の
SELECTCASE TFLAG:148
	CASE 1
		PRINT ローション
	CASE 2
		PRINT 媚薬
	CASE 3
		PRINT 精液
	CASE 4
		PRINT お酒
	CASE 5
		PRINT トロロ
	CASE 6
		PRINT 国士無双の薬
	CASE 7
		PRINT 液化した厄
	CASEELSE
		PRINT 液体
ENDSELECT
PRINTFORML を口に含ませると、%CALLNAME:PLAYER%の口内へと移した

;-------------------------------------------------
;固有の実行判定
;-------------------------------------------------
@COM_ORDER_621, ARG
LOCAL:99 = ARG
;ABL:欲望
IF ABL:欲望
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = ABL:欲望
	TFLAG:240 += LOCAL:99
	RESULTS = %RESULTS% %ABLNAME:11%LV{LOCAL:99}({LOCAL:99})
ENDIF
;ABL:奉仕精神
IF ABL:奉仕精神
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = ABL:奉仕精神
	TFLAG:240 += LOCAL:99 * 4
	RESULTS = %RESULTS% %ABLNAME:13%LV{LOCAL:99}({LOCAL:99 * 4})
ENDIF

;快楽刻印
IF MARK:快楽刻印
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = MARK:快楽刻印
	TFLAG:240 += LOCAL:99 * 2
	RESULTS = %RESULTS% %MARKNAME:1%LV{LOCAL:99}({LOCAL:99 * 2})
ENDIF

;PALAM:欲情
GETPALAMLV PALAM:欲情, 5
LOCAL:2 = RESULT
IF LOCAL:2
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = LOCAL:2
	TFLAG:240 += LOCAL:99
	RESULTS = %RESULTS% %PALAMNAME:13%LV{LOCAL:2}({LOCAL:99})
ENDIF

;恥じらい
IF TALENT:恥じらい
	RESULTS = %RESULTS% - 
	LOCAL:99 = 1
	TFLAG:240 -= LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:35%({LOCAL:99})
ENDIF
;汚臭鈍感
IF TALENT:汚臭鈍感
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = 1
	TFLAG:240 += LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:61%({LOCAL:99})
;汚臭敏感
ELSEIF TALENT:汚臭敏感
	RESULTS = %RESULTS% - 
	LOCAL:99 = 1
	TFLAG:240 -= LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:62%({LOCAL:99})
ENDIF
;献身的
IF TALENT:献身的
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = 6
	TFLAG:240 += LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:63%({LOCAL:99})
ENDIF
;快感の否定
IF TALENT:快感の否定
	RESULTS = %RESULTS% - 
	LOCAL:99 = 1
	TFLAG:240 -= LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:71%({LOCAL:99})
ENDIF
;恋慕
IF TALENT:恋慕 && ASSIPLAY == 0
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = 5
	TFLAG:240 += LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:150%({LOCAL:99})
ENDIF
;キス魔
IF TALENT:キス魔
	SIF LOCAL:99
		RESULTS = %RESULTS% + 
	LOCAL:99 = 10
	TFLAG:240 += LOCAL:99
	RESULTS = %RESULTS% %TALENTNAME:176%({LOCAL:99})
ENDIF

;調教者の口の汚れ
TFLAG:242 = COMORDER_STAIN_CALC(0, 1)
;精液の口移し以外は汚れがそれほど影響しない
SIF TFLAG:148 != 3
	TFLAG:242 /= 2

;汚れあり
IF TFLAG:242
	RESULTS = %RESULTS% - 
	TFLAG:240 -= TFLAG:242
	RESULTS = %RESULTS% 汚れあり
	;汚臭鈍感
	IF TALENT:汚臭鈍感
		RESULTS = %RESULTS%、%TALENTNAME:61%
	ELSEIF TALENT:汚臭敏感
		RESULTS = %RESULTS%、%TALENTNAME:62%
	ENDIF
	RESULTS = %RESULTS%({TFLAG:242})
	LOCAL:99 = 1
ENDIF

SELECTCASE TFLAG:148
	CASE 1
		;ローション
		TFLAG:241 = 25
	CASE 2
		;媚薬
		TFLAG:241 = 40
	CASE 3
		;精液
		TFLAG:241 = 60
	CASE 4
		;酒
		TFLAG:241 = 20
	CASE 5
		;トロロ
		TFLAG:241 = 30
	CASE 6
		;国士無双の薬
		TFLAG:241 = 25
	CASE 7
		;厄毒
		TFLAG:241 = 35
	CASEELSE
		TFLAG:241 = 15
ENDSELECT

;-------------------------------------------------
;このコマンドのデフォルト射精箇所タイプ等の処理
;-------------------------------------------------
@COM_SHOOT_621
;デフォルト射精箇所タイプを設定
TFLAG:703 = 15
;射精箇所選択の可・不可
TFLAG:704 = 0
